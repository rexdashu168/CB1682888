<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v5.0 - Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</title>
    
    <!-- SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        /* è¼‰å…¥ç•«é¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-icon {
            font-size: 4em;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .loading-text {
            font-size: 1.5em;
            margin-top: 20px;
            font-weight: 600;
        }
        
        .loading-progress {
            margin-top: 30px;
            font-size: 1em;
            opacity: 0.9;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-container.active {
            display: block;
        }
        
        /* æ¨™é¡Œå€ */
        .header {
            text-align: center;
            color: white;
            padding: 30px 20px;
        }
        
        .header-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .header-title {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            font-size: 1em;
            opacity: 0.95;
        }
        
        .header-stats {
            margin-top: 15px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* å¿«é€Ÿè¼‰å…¥ */
        .quick-load-section {
            margin-bottom: 20px;
        }
        
        .quick-load-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-btn {
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* æŒ‰éˆ• */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* çµæœå€ */
        .result-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .result-section.active {
            display: block;
        }
        
        .strategy-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .strategy-card.recommended {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left-color: #667eea;
            border-left-width: 5px;
        }
        
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .strategy-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #1e3c72;
        }
        
        .strategy-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .strategy-price {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }
        
        .strategy-desc {
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        /* åˆ†æè©³æƒ… */
        .analysis-detail {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .analysis-item:last-child {
            border-bottom: none;
        }
        
        .analysis-label {
            font-weight: 600;
            color: #555;
        }
        
        .analysis-value {
            color: #667eea;
            font-weight: 600;
        }
        
        /* è­¦å‘Šè¨Šæ¯ */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* Rexå¤§å”çš„æé†’ */
        .rex-tip {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .rex-tip-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 10px;
        }
        
        .rex-tip-content {
            color: #555;
            line-height: 1.8;
        }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .quick-load-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-icon">ğŸ¯</div>
        <div class="loading-text">AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ±</div>
        <div class="loading-progress" id="loading-progress">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div id="main-container" class="main-container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <div class="header-icon">ğŸ¯</div>
            <h1 class="header-title">AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ±</h1>
            <p class="header-subtitle">åŸºæ–¼297æª”ç«¶æ‹çµ±è¨ˆ | 8å¤§ç¶­åº¦AIåˆ†æ | Rexå¤§å”ç¶“é©—æ•´åˆ</p>
            <p class="header-stats" id="header-stats">è³‡æ–™è¼‰å…¥ä¸­...</p>
        </div>

        <!-- å¿«é€Ÿè¼‰å…¥ -->
        <div class="card">
            <div class="card-title">âš¡ å¿«é€Ÿè¼‰å…¥ç™¼è¡Œæ¡ˆä»¶</div>
            <div class="quick-load-section">
                <div class="alert alert-info">
                    é»é¸ä¸‹æ–¹æŒ‰éˆ•å¿«é€Ÿè¼‰å…¥æœ€æ–°ç™¼è¡Œæ¡ˆä»¶çš„åŸºæœ¬è³‡æ–™
                </div>
                <div id="quick-load-buttons" class="quick-load-buttons">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ç«¶æ‹è¨ˆç®— -->
        <div class="card">
            <div class="card-title">ğŸ¤– AIç«¶æ‹åƒ¹æ ¼è¨ˆç®—</div>
            
            <form id="auction-form">
                <!-- CBåŸºæœ¬è³‡è¨Š -->
                <div class="form-group">
                    <label class="form-label">CBä»£è™Ÿï¼ˆé¸å¡«ï¼Œç”¨æ–¼æŸ¥è©¢ï¼‰</label>
                    <input type="text" class="form-input" id="cb-code" 
                           placeholder="ä¾‹å¦‚ï¼š11011ï¼ˆè¼¸å…¥å¾Œè‡ªå‹•å¸¶å‡ºè³‡æ–™ï¼‰">
                </div>

                <div class="form-group">
                    <label class="form-label">CBåç¨±ï¼ˆé¸å¡«ï¼‰</label>
                    <input type="text" class="form-input" id="cb-name" 
                           placeholder="ä¾‹å¦‚ï¼šå°æ³¥ä¸€æ°¸">
                </div>

                <!-- é—œéµåƒæ•¸ -->
                <div class="form-group">
                    <label class="form-label">ç†è«–åƒ¹æ ¼ *ï¼ˆå¿…å¡«ï¼‰</label>
                    <input type="number" class="form-input" id="theory-price" 
                           placeholder="è«‹è¼¸å…¥ç†è«–åƒ¹æ ¼" step="0.01" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ç”¢æ¥­åˆ†é¡ *</label>
                        <select class="form-select" id="industry" required>
                            <option value="">è«‹é¸æ“‡ç”¢æ¥­</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç™¼è¡Œè¦æ¨¡ï¼ˆå„„å…ƒï¼‰*</label>
                        <input type="number" class="form-input" id="issue-amount" 
                               placeholder="ç™¼è¡Œè¦æ¨¡" step="0.1" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å‚µåˆ¸å¹´æœŸ *</label>
                        <select class="form-select" id="period" required>
                            <option value="">è«‹é¸æ“‡å¹´æœŸ</option>
                            <option value="3">3å¹´</option>
                            <option value="5">5å¹´</option>
                            <option value="7">7å¹´</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ“”ä¿æƒ…å½¢ *</label>
                        <select class="form-select" id="collateral" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                            <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ä¿¡ç”¨è©•ç­‰ï¼ˆTCRIï¼‰*</label>
                        <select class="form-select" id="rating" required>
                            <option value="">è«‹é¸æ“‡ä¿¡è©•</option>
                            <option value="2">2åˆ†</option>
                            <option value="3">3åˆ†</option>
                            <option value="4">4åˆ†</option>
                            <option value="5">5åˆ†</option>
                            <option value="6">6åˆ†</option>
                            <option value="7">7åˆ†</option>
                            <option value="8">8åˆ†</option>
                            <option value="9">9åˆ†</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è‚¡æœ¬è¦æ¨¡ï¼ˆå„„å…ƒï¼‰*</label>
                        <input type="number" class="form-input" id="capital" 
                               placeholder="è‚¡æœ¬" step="0.1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å¸‚å ´æ°›åœï¼ˆåƒè€ƒæœŸé–“ï¼‰*</label>
                    <select class="form-select" id="market-mood" required>
                        <option value="">è«‹é¸æ“‡åƒè€ƒæœŸé–“</option>
                        <option value="1m">è¿‘1å€‹æœˆ</option>
                        <option value="3m">è¿‘3å€‹æœˆ</option>
                        <option value="6m">è¿‘6å€‹æœˆ</option>
                        <option value="1y">è¿‘1å¹´</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    ğŸ¯ AIè¨ˆç®—å»ºè­°åƒ¹æ ¼
                </button>
            </form>
        </div>

        <!-- è¨ˆç®—çµæœ -->
        <div id="result-section" class="card result-section">
            <div class="card-title">ğŸ“Š AIå»ºè­°åƒ¹æ ¼</div>
            
            <div id="result-content">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- Rexå¤§å”çš„æŠ•è³‡æé†’ -->
            <div class="rex-tip">
                <div class="rex-tip-title">ğŸ’¡ Rexå¤§å”çš„æŠ•è³‡æé†’</div>
                <div class="rex-tip-content">
                    <p><strong>1. å°ˆæ³¨æ–¼é¢¨éšªï¼Œä¸è¿½æ±‚å ±é…¬</strong><br>
                    æ§åˆ¶ä¸‹æª”é¢¨éšªå„ªå…ˆï¼Œä¸è¦ç‚ºäº†é«˜å ±é…¬å†’å¤§é¢¨éšªã€‚</p>
                    
                    <p style="margin-top:10px;"><strong>2. ç·´ç¿’åªå¯«ä¸€å€‹åƒ¹æ ¼</strong><br>
                    é›–ç„¶ç³»çµ±æä¾›ä¸‰ç¨®ç­–ç•¥ï¼Œä½†å»ºè­°é¸å®šä¸€å€‹åƒ¹æ ¼ï¼Œæ·±æ€ç†Ÿæ…®å¾ŒæŠ•æ¨™ã€‚</p>
                    
                    <p style="margin-top:10px;"><strong>3. æ²’æ¨™åˆ°ä¹Ÿæ˜¯ä¸€ç¨®ä¿è­·</strong><br>
                    ä¸è¦åŸ·è‘—æ–¼å¾—æ¨™ï¼Œä¿ç•™è³‡é‡‘ç­‰å¾…ä¸‹æ¬¡æ›´å¥½çš„æ©Ÿæœƒã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // å…¨åŸŸè®Šæ•¸
        // ============================================
        let auctionData = [];      // ç«¶æ‹è³‡æ–™åº«
        let industryData = {};     // ç”¢æ¥­åˆ†é¡
        let cbBasicData = {};      // CBåŸºæœ¬è³‡æ–™
        let issueData = [];        // ç™¼è¡Œæ¡ˆä»¶
        let statistics = {};       // çµ±è¨ˆæ•¸æ“š

        // ============================================
        // åˆå§‹åŒ–ç³»çµ±
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadExcelData();
                calculateStatistics();
                populateIndustryOptions();
                setupEventListeners();
                generateQuickLoadButtons();
                hideLoading();
            } catch (error) {
                console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                alert('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        });

        // ============================================
        // è¼‰å…¥Excelè³‡æ–™
        // ============================================
        async function loadExcelData() {
            updateProgress('æ­£åœ¨è¼‰å…¥Excelè³‡æ–™...');
            
            const response = await fetch('00_CBä»£è™Ÿåç¨±.xlsx');
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, {type: 'array'});

            // è¼‰å…¥å·¥ä½œè¡¨04ï¼šç«¶æ‹è³‡æ–™åº«
            updateProgress('è¼‰å…¥ç«¶æ‹è³‡æ–™åº«...');
            const sheet04 = workbook.Sheets['04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«'];
            auctionData = XLSX.utils.sheet_to_json(sheet04);
            
            // è¼‰å…¥å·¥ä½œè¡¨16ï¼šç”¢æ¥­åˆ†é¡
            updateProgress('è¼‰å…¥ç”¢æ¥­åˆ†é¡...');
            const sheet16 = workbook.Sheets['16_ç”¢æ¥­åˆ†é¡'];
            const industryArray = XLSX.utils.sheet_to_json(sheet16);
            industryArray.forEach(row => {
                industryData[row['è‚¡ç¥¨ä»£è™Ÿ']] = row;
            });
            
            // è¼‰å…¥å·¥ä½œè¡¨00ï¼šCBåŸºæœ¬è³‡æ–™
            updateProgress('è¼‰å…¥CBåŸºæœ¬è³‡æ–™...');
            const sheet00 = workbook.Sheets['00_CBä»£è™Ÿåç¨±éæ¿¾åŠæ›ç‰Œé«˜ä½_20251031'];
            const cbArray = XLSX.utils.sheet_to_json(sheet00);
            cbArray.forEach(row => {
                cbBasicData[row['ä»£è™Ÿ']] = row;
            });
            
            // è¼‰å…¥å·¥ä½œè¡¨06ï¼šç™¼è¡Œæ¡ˆä»¶
            updateProgress('è¼‰å…¥ç™¼è¡Œæ¡ˆä»¶...');
            const sheet06 = workbook.Sheets['06_ç™¼è¡Œæ¡ˆä»¶'];
            issueData = XLSX.utils.sheet_to_json(sheet06);
            
            updateProgress('è³‡æ–™è¼‰å…¥å®Œæˆï¼');
        }

        // ============================================
        // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
        // ============================================
        function calculateStatistics() {
            updateProgress('è¨ˆç®—çµ±è¨ˆæ•¸æ“š...');
            
            statistics = {
                totalSamples: auctionData.length,
                byTheoryPrice: {},
                byIndustry: {},
                byCollateral: {},
                byAmount: {},
                byPeriod: {},
                byCapital: {},
                byRating: {},
                byMarketMood: {}
            };

            // è¨ˆç®—å„ç¶­åº¦çµ±è¨ˆ
            auctionData.forEach(item => {
                // ç¶­åº¦1: ç†è«–åƒ¹æ ¼
                const priceRange = getPriceRange(item['ç†è«–åƒ¹']);
                updateDimensionStats(statistics.byTheoryPrice, priceRange, item);
                
                // ç¶­åº¦2: ç”¢æ¥­åˆ¥
                const industry = item['ç”¢æ¥­åˆ†é¡'];
                updateDimensionStats(statistics.byIndustry, industry, item);
                
                // ç¶­åº¦3: æ“”ä¿æƒ…å½¢
                const collateral = item['æ“”ä¿'];
                updateDimensionStats(statistics.byCollateral, collateral, item);
                
                // ç¶­åº¦4: ç™¼è¡Œè¦æ¨¡
                const amountRange = getAmountRange(item['ç™¼è¡Œè¦æ¨¡']);
                updateDimensionStats(statistics.byAmount, amountRange, item);
                
                // ç¶­åº¦5: å¹´æœŸ
                const period = item['å¹´æœŸ'];
                updateDimensionStats(statistics.byPeriod, period, item);
                
                // ç¶­åº¦6: è‚¡æœ¬
                const capitalRange = getCapitalRange(item['è‚¡æœ¬']);
                updateDimensionStats(statistics.byCapital, capitalRange, item);
                
                // ç¶­åº¦7: ä¿¡è©•
                const ratingRange = getRatingRange(item['ä¿¡è©•']);
                updateDimensionStats(statistics.byRating, ratingRange, item);
            });

            // è¨ˆç®—å¸‚å ´æ°›åœï¼ˆåŸºæ–¼é–‹æ¨™æ—¥æœŸï¼‰
            calculateMarketMood();
        }

        // ============================================
        // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°ç¶­åº¦çµ±è¨ˆ
        // ============================================
        function updateDimensionStats(dimension, key, item) {
            if (!key) return;
            
            if (!dimension[key]) {
                dimension[key] = {
                    count: 0,
                    minBidSum: 0,
                    minPremiumSum: 0,
                    avgBidSum: 0,
                    avgPremiumSum: 0
                };
            }
            
            dimension[key].count++;
            dimension[key].minBidSum += item['æœ€ä½å¾—æ¨™'] || 0;
            dimension[key].minPremiumSum += (item['æœ€ä½æº¢åƒ¹'] || 0) * 100; // è½‰æˆç™¾åˆ†æ¯”
            dimension[key].avgBidSum += item['å¹³å‡å¾—æ¨™'] || 0;
            dimension[key].avgPremiumSum += (item['å¹³å‡æº¢åƒ¹'] || 0) * 100; // è½‰æˆç™¾åˆ†æ¯”
        }

        // ============================================
        // åƒ¹æ ¼å€é–“åˆ¤æ–·
        // ============================================
        function getPriceRange(price) {
            if (price < 85) return '<85å…ƒ';
            if (price < 90) return '85-90å…ƒ';
            if (price < 95) return '90-95å…ƒ';
            if (price < 98) return '95-98å…ƒ';
            if (price < 100) return '98-100å…ƒ';
            if (price < 102) return '100-102å…ƒ';
            if (price < 105) return '102-105å…ƒ';
            if (price < 110) return '105-110å…ƒ';
            return '>110å…ƒ';
        }

        function getAmountRange(amount) {
            if (amount < 2) return '<2å„„';
            if (amount < 5) return '2-5å„„';
            if (amount < 10) return '5-10å„„';
            if (amount < 15) return '10-15å„„';
            if (amount < 20) return '15-20å„„';
            return '>20å„„';
        }

        function getCapitalRange(capital) {
            if (capital < 3) return '<3å„„';
            if (capital < 6) return '3-6å„„';
            if (capital < 10) return '6-10å„„';
            if (capital < 15) return '10-15å„„';
            if (capital < 20) return '15-20å„„';
            return '>20å„„';
        }

        function getRatingRange(rating) {
            if (rating <= 3) return '2-3åˆ†';
            if (rating <= 5) return '4-5åˆ†';
            if (rating <= 7) return '6-7åˆ†';
            return '8-9åˆ†';
        }

        // ============================================
        // è¨ˆç®—å¸‚å ´æ°›åœ
        // ============================================
        function calculateMarketMood() {
            const now = new Date();
            const periods = {
                '1m': 30,
                '3m': 90,
                '6m': 180,
                '1y': 365
            };

            Object.keys(periods).forEach(key => {
                const days = periods[key];
                const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                
                const recentData = auctionData.filter(item => {
                    const itemDate = new Date(item['é–‹æ¨™æ—¥æœŸ']);
                    return itemDate >= cutoffDate;
                });

                if (recentData.length > 0) {
                    const avgPremium = recentData.reduce((sum, item) => 
                        sum + ((item['æœ€ä½æº¢åƒ¹'] || 0) * 100), 0) / recentData.length;
                    
                    statistics.byMarketMood[key] = {
                        count: recentData.length,
                        avgPremium: avgPremium
                    };
                }
            });
        }

        // ============================================
        // å¡«å……ç”¢æ¥­é¸é …
        // ============================================
        function populateIndustryOptions() {
            const industrySelect = document.getElementById('industry');
            const industries = new Set();
            
            auctionData.forEach(item => {
                if (item['ç”¢æ¥­åˆ†é¡']) {
                    industries.add(item['ç”¢æ¥­åˆ†é¡']);
                }
            });
            
            Array.from(industries).sort().forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industrySelect.appendChild(option);
            });
        }

        // ============================================
        // ç”Ÿæˆå¿«é€Ÿè¼‰å…¥æŒ‰éˆ•
        // ============================================
        function generateQuickLoadButtons() {
            const container = document.getElementById('quick-load-buttons');
            container.innerHTML = '';
            
            // åªå–å‰10å€‹ç™¼è¡Œæ¡ˆä»¶
            const recentIssues = issueData.slice(0, 10);
            
            recentIssues.forEach(issue => {
                if (issue['æ¨™çš„ä»£è™Ÿ']) {
                    const btn = document.createElement('button');
                    btn.className = 'quick-btn';
                    btn.textContent = issue['ç™¼è¡Œæ¨™çš„'] || issue['æ¨™çš„ä»£è™Ÿ'];
                    btn.onclick = () => quickLoadIssue(issue['æ¨™çš„ä»£è™Ÿ']);
                    container.appendChild(btn);
                }
            });
        }

        // ============================================
        // å¿«é€Ÿè¼‰å…¥ç™¼è¡Œæ¡ˆä»¶
        // ============================================
        function quickLoadIssue(cbCode) {
            // å¾ç™¼è¡Œæ¡ˆä»¶æ‰¾è³‡æ–™
            const issue = issueData.find(item => item['æ¨™çš„ä»£è™Ÿ'] === cbCode);
            if (!issue) return;
            
            // å¡«å……è¡¨å–®
            document.getElementById('cb-code').value = cbCode;
            document.getElementById('cb-name').value = issue['ç™¼è¡Œæ¨™çš„'] || '';
            
            if (issue['è‚¡æœ¬']) {
                document.getElementById('capital').value = issue['è‚¡æœ¬'];
            }
            
            if (issue['ç™¼è¡Œé‡']) {
                document.getElementById('issue-amount').value = issue['ç™¼è¡Œé‡'];
            }
            
            if (issue['å¹´æœŸ']) {
                document.getElementById('period').value = issue['å¹´æœŸ'];
            }
            
            // æ“”ä¿æƒ…å½¢åˆ¤æ–·
            if (issue['TCRI/æ“”ä¿']) {
                const tcri = issue['TCRI/æ“”ä¿'];
                if (tcri.includes('æ“”ä¿')) {
                    document.getElementById('collateral').value = 'æœ‰æ“”ä¿';
                } else {
                    document.getElementById('collateral').value = 'ç„¡æ“”ä¿';
                }
                
                // æå–ä¿¡è©•æ•¸å­—
                const ratingMatch = tcri.match(/\d+/);
                if (ratingMatch) {
                    document.getElementById('rating').value = ratingMatch[0];
                }
            }
            
            // å¾ç”¢æ¥­è³‡æ–™æ‰¾ç”¢æ¥­åˆ†é¡
            const stockCode = cbCode.substring(0, 4);
            if (industryData[stockCode]) {
                document.getElementById('industry').value = industryData[stockCode]['ç”¢æ¥­åˆ†é¡'];
            }
            
            alert(`å·²è¼‰å…¥ ${issue['ç™¼è¡Œæ¨™çš„']} çš„åŸºæœ¬è³‡æ–™\nè«‹è£œå……ç†è«–åƒ¹æ ¼å¾Œå³å¯è¨ˆç®—`);
        }

        // ============================================
        // è¨­å®šäº‹ä»¶ç›£è½
        // ============================================
        function setupEventListeners() {
            // è¡¨å–®æäº¤
            document.getElementById('auction-form').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateAIPrice();
            });
            
            // CBä»£è™Ÿè¼¸å…¥
            document.getElementById('cb-code').addEventListener('blur', function() {
                const cbCode = this.value.trim();
                if (cbCode && cbBasicData[cbCode]) {
                    const cb = cbBasicData[cbCode];
                    document.getElementById('cb-name').value = cb['åç¨±'];
                    
                    // å¦‚æœæœ‰è‚¡ç¥¨ä»£è™Ÿï¼ŒæŸ¥æ‰¾ç”¢æ¥­
                    const stockCode = cb['è‚¡ç¥¨ä»£è™Ÿ'];
                    if (industryData[stockCode]) {
                        document.getElementById('industry').value = industryData[stockCode]['ç”¢æ¥­åˆ†é¡'];
                    }
                }
            });
        }

        // ============================================
        // AIåƒ¹æ ¼è¨ˆç®—
        // ============================================
        function calculateAIPrice() {
            // å–å¾—è¼¸å…¥å€¼
            const theoryPrice = parseFloat(document.getElementById('theory-price').value);
            const industry = document.getElementById('industry').value;
            const issueAmount = parseFloat(document.getElementById('issue-amount').value);
            const period = parseInt(document.getElementById('period').value);
            const collateral = document.getElementById('collateral').value;
            const rating = parseInt(document.getElementById('rating').value);
            const capital = parseFloat(document.getElementById('capital').value);
            const marketMood = document.getElementById('market-mood').value;

            // 1. åŸºæº–æº¢åƒ¹ï¼ˆç†è«–åƒ¹æ ¼ï¼‰
            const priceRange = getPriceRange(theoryPrice);
            const priceStats = getAvgPremium(statistics.byTheoryPrice, priceRange);
            let finalPremium = priceStats.avgPremium;

            // 2. ç”¢æ¥­èª¿æ•´
            const industryStats = getAvgPremium(statistics.byIndustry, industry);
            const overallAvg = calculateOverallAvgPremium();
            const industryAdjust = industryStats.avgPremium - overallAvg;
            finalPremium += industryAdjust;

            // 3. æ“”ä¿èª¿æ•´
            const collateralStats = getAvgPremium(statistics.byCollateral, collateral);
            const collateralAdjust = collateralStats.avgPremium - overallAvg;
            finalPremium += collateralAdjust;

            // 4. å¸‚å ´æ°›åœèª¿æ•´
            let moodAdjust = 0;
            if (statistics.byMarketMood[marketMood]) {
                moodAdjust = statistics.byMarketMood[marketMood].avgPremium - overallAvg;
                finalPremium += moodAdjust;
            }

            // è¨ˆç®—å»ºè­°åƒ¹æ ¼
            const suggestedPrice = theoryPrice * (1 + finalPremium / 100);
            
            // ä¸‰ç¨®ç­–ç•¥
            const strategies = {
                aggressive: suggestedPrice + 2,
                balanced: suggestedPrice,
                conservative: suggestedPrice - 2
            };

            // é¡¯ç¤ºçµæœ
            displayResult(strategies, {
                theoryPrice,
                basePremium: priceStats.avgPremium,
                industryAdjust,
                collateralAdjust,
                moodAdjust,
                finalPremium,
                priceStats,
                industryStats,
                sampleCount: priceStats.count
            });
        }

        // ============================================
        // å–å¾—å¹³å‡æº¢åƒ¹
        // ============================================
        function getAvgPremium(dimension, key) {
            if (!dimension[key] || dimension[key].count === 0) {
                return { avgPremium: 0, count: 0 };
            }
            
            const data = dimension[key];
            return {
                avgPremium: data.minPremiumSum / data.count,
                count: data.count
            };
        }

        // ============================================
        // è¨ˆç®—æ•´é«”å¹³å‡æº¢åƒ¹
        // ============================================
        function calculateOverallAvgPremium() {
            const totalPremium = auctionData.reduce((sum, item) => 
                sum + ((item['æœ€ä½æº¢åƒ¹'] || 0) * 100), 0);
            return totalPremium / auctionData.length;
        }

        // ============================================
        // é¡¯ç¤ºçµæœ
        // ============================================
        function displayResult(strategies, analysis) {
            const resultSection = document.getElementById('result-section');
            const resultContent = document.getElementById('result-content');
            
            resultContent.innerHTML = `
                <!-- ä¸‰ç¨®ç­–ç•¥ -->
                <div class="strategy-card">
                    <div class="strategy-header">
                        <span class="strategy-name">ğŸ”¥ ç©æ¥µå‹</span>
                    </div>
                    <div class="strategy-price">${strategies.aggressive.toFixed(2)} å…ƒ</div>
                    <div class="strategy-desc">
                        é©åˆï¼šæƒ³è¦ç©æ¥µå¾—æ¨™ï¼Œé¡˜æ„æ¥å—è¼ƒé«˜æˆæœ¬<br>
                        é¢¨éšªï¼šå¾—æ¨™æ©Ÿç‡é«˜ï¼Œä½†æˆæœ¬è¼ƒé«˜
                    </div>
                </div>

                <div class="strategy-card recommended">
                    <div class="strategy-header">
                        <span class="strategy-name">â­ ç©©å¥å‹</span>
                        <span class="strategy-badge">æ¨è–¦</span>
                    </div>
                    <div class="strategy-price">${strategies.balanced.toFixed(2)} å…ƒ</div>
                    <div class="strategy-desc">
                        é©åˆï¼šå¹³è¡¡æˆæœ¬èˆ‡å¾—æ¨™æ©Ÿç‡çš„æœ€ä½³é¸æ“‡<br>
                        é¢¨éšªï¼šåŸºæ–¼AIçµ±è¨ˆçš„åˆç†åƒ¹æ ¼å€é–“
                    </div>
                </div>

                <div class="strategy-card">
                    <div class="strategy-header">
                        <span class="strategy-name">ğŸ›¡ï¸ ä¿å®ˆå‹</span>
                    </div>
                    <div class="strategy-price">${strategies.conservative.toFixed(2)} å…ƒ</div>
                    <div class="strategy-desc">
                        é©åˆï¼šé‡è¦–æˆæœ¬æ§åˆ¶ï¼Œæ²’æ¨™åˆ°ä¹Ÿæ˜¯ä¿è­·<br>
                        é¢¨éšªï¼šå¾—æ¨™æ©Ÿç‡è¼ƒä½ï¼Œä½†æˆæœ¬æœ€å„ª
                    </div>
                </div>

                <!-- åˆ†æè©³æƒ… -->
                <div class="analysis-detail">
                    <h3 style="margin-bottom:15px; color:#1e3c72;">ğŸ“Š AIè¨ˆç®—è©³æƒ…</h3>
                    
                    <div class="analysis-item">
                        <span class="analysis-label">ç†è«–åƒ¹æ ¼</span>
                        <span class="analysis-value">${analysis.theoryPrice.toFixed(2)} å…ƒ</span>
                    </div>
                    
                    <div class="analysis-item">
                        <span class="analysis-label">åŸºæº–æº¢åƒ¹ï¼ˆç†è«–åƒ¹å€é–“ï¼‰</span>
                        <span class="analysis-value">${analysis.basePremium.toFixed(2)}%</span>
                    </div>
                    
                    <div class="analysis-item">
                        <span class="analysis-label">ç”¢æ¥­èª¿æ•´</span>
                        <span class="analysis-value">${analysis.industryAdjust > 0 ? '+' : ''}${analysis.industryAdjust.toFixed(2)}%</span>
                    </div>
                    
                    <div class="analysis-item">
                        <span class="analysis-label">æ“”ä¿èª¿æ•´</span>
                        <span class="analysis-value">${analysis.collateralAdjust > 0 ? '+' : ''}${analysis.collateralAdjust.toFixed(2)}%</span>
                    </div>
                    
                    <div class="analysis-item">
                        <span class="analysis-label">å¸‚å ´æ°›åœèª¿æ•´</span>
                        <span class="analysis-value">${analysis.moodAdjust > 0 ? '+' : ''}${analysis.moodAdjust.toFixed(2)}%</span>
                    </div>
                    
                    <div class="analysis-item">
                        <span class="analysis-label"><strong>æœ€çµ‚æº¢åƒ¹ç‡</strong></span>
                        <span class="analysis-value"><strong>${analysis.finalPremium.toFixed(2)}%</strong></span>
                    </div>
                    
                    <div class="analysis-item">
                        <span class="analysis-label">çµ±è¨ˆæ¨£æœ¬æ•¸</span>
                        <span class="analysis-value">${analysis.sampleCount} æª”æ¡ˆä¾‹</span>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <strong>âš ï¸ é‡è¦æé†’</strong><br>
                    â€¢ AIå»ºè­°åƒ¹æ ¼åŸºæ–¼æ­·å²çµ±è¨ˆï¼Œéå»ç¸¾æ•ˆä¸ä»£è¡¨æœªä¾†çµæœ<br>
                    â€¢ å¯¦éš›æŠ•æ¨™è«‹ä¾å€‹äººé¢¨éšªæ‰¿å—åº¦æ±ºå®š<br>
                    â€¢ å»ºè­°æ­é…å…¶ä»–åˆ†æå·¥å…·ç¶œåˆåˆ¤æ–·
                </div>
            `;
            
            resultSection.classList.add('active');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================
        // æ›´æ–°è¼‰å…¥é€²åº¦
        // ============================================
        function updateProgress(text) {
            document.getElementById('loading-progress').textContent = text;
        }

        // ============================================
        // éš±è—è¼‰å…¥ç•«é¢
        // ============================================
        function hideLoading() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-container').classList.add('active');
            
            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('header-stats').textContent = 
                `åŸºæ–¼ ${statistics.totalSamples} æª”ç«¶æ‹æ¡ˆä¾‹ | è³‡æ–™æ›´æ–°ï¼š2025-10-31`;
        }
    </script>
</body>
</html>
